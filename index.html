<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT 账号商城</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- Particles.js -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #020617; /* Deep Blue */
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .ql-toolbar {
            background-color: #e2e8f0;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .ql-container {
            background-color: #f8fafc;
            color: #0f172a;
            border-radius: 0 0 0.5rem 0.5rem;
            height: 200px;
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.3s ease;
            pointer-events: none;
            opacity: 0;
        }
        .modal.active {
            pointer-events: auto;
            opacity: 1;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Background -->
    <div id="particles-js"></div>

    <!-- Navbar -->
    <nav class="glass-panel sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 id="site-title" class="text-2xl font-bold text-blue-400 cursor-pointer select-none tracking-wider">GPT Store</h1>
            <div class="flex gap-4">
                <button onclick="renderHome()" class="hover:text-blue-400 transition"><i class="fas fa-home"></i> 首页</button>
                <button id="admin-link" onclick="checkAdminLogin()" class="hidden hover:text-blue-400 transition"><i class="fas fa-cog"></i> 管理</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app" class="flex-grow container mx-auto px-4 py-8">
        <!-- Content injected via JS -->
    </main>

    <!-- Footer -->
    <footer class="glass-panel mt-auto">
        <div class="container mx-auto px-4 py-6 text-center text-gray-400">
            <p id="footer-contact"></p>
            <p class="text-sm mt-2">&copy; 2025 GPT Store. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modals -->
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="glass-panel p-8 rounded-xl w-full max-w-sm relative">
            <button onclick="closeModal('login-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-4 text-center">管理员登录</h2>
            <input type="password" id="admin-pass-input" placeholder="请输入密码" class="w-full p-3 rounded bg-slate-800 border border-slate-600 text-white mb-4 focus:outline-none focus:border-blue-500">
            <button onclick="attemptLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded transition">登录</button>
        </div>
    </div>

    <!-- Buy Modal -->
    <div id="buy-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="glass-panel p-8 rounded-xl w-full max-w-md relative text-center">
            <button onclick="closeModal('buy-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-blue-400">联系购买</h2>
            <div class="space-y-4 text-lg">
                <div class="p-4 bg-slate-800 rounded-lg flex items-center justify-between">
                    <span><i class="fab fa-weixin text-green-500 mr-2"></i> 微信</span>
                    <span id="modal-wechat" class="font-mono select-all"></span>
                </div>
                <div class="p-4 bg-slate-800 rounded-lg flex items-center justify-between">
                    <span><i class="fab fa-qq text-blue-500 mr-2"></i> QQ</span>
                    <span id="modal-qq" class="font-mono select-all"></span>
                </div>
            </div>
            <p class="mt-6 text-gray-400 text-sm">请添加客服好友，备注“购买GPT”</p>
        </div>
    </div>

    <!-- Product Edit Modal (Admin) -->
    <div id="product-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80">
        <div class="glass-panel p-6 rounded-xl w-full max-w-5xl h-[90vh] overflow-y-auto relative">
            <button onclick="closeModal('product-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-6" id="product-modal-title">编辑商品</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">商品名称</label>
                    <input type="text" id="edit-name" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">价格 (¥)</label>
                    <input type="text" id="edit-price" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" placeholder="例如 199">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">库存</label>
                    <input type="number" id="edit-stock" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" min="0">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">标签 (逗号分隔)</label>
                    <input type="text" id="edit-tags" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" placeholder="GPT-4, 限时优惠">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">简短描述</label>
                <textarea id="edit-short-desc" rows="3" class="w-full p-3 rounded bg-slate-800 border border-slate-600 text-white"></textarea>
                <p class="text-xs text-gray-500 mt-1">展示在商品卡片和详情页顶部，建议 80 字以内。</p>
            </div>

            <div class="flex flex-wrap items-center justify-between bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 mb-6">
                <label class="flex items-center gap-2 text-sm text-gray-300">
                    <input type="checkbox" id="edit-enabled" class="w-4 h-4 text-blue-500">
                    启用商品（前台展示）
                </label>
                <span class="text-xs text-gray-500">停用后仅后台可见。</span>
            </div>

            <div class="mb-6">
                <label class="block text-sm text-gray-400 mb-2">主图</label>
                <div class="flex flex-wrap gap-2 mb-3">
                    <input type="text" id="cover-url-input" placeholder="图片URL..." class="flex-grow p-2 rounded bg-slate-800 border border-slate-600 text-white">
                    <button type="button" onclick="applyCoverUrl()" class="bg-slate-700 px-3 rounded hover:bg-slate-600 text-sm">使用URL</button>
                    <label class="bg-blue-600 px-4 py-2 rounded cursor-pointer hover:bg-blue-700 text-sm font-medium">
                        <i class="fas fa-upload mr-1"></i> 上传
                        <input type="file" id="cover-file-input" class="hidden" accept="image/*" onchange="handleCoverUpload(this)">
                    </label>
                </div>
                <div id="cover-preview" class="h-48 rounded-xl border border-slate-700 bg-slate-900 flex items-center justify-center text-gray-500 text-sm">暂无主图</div>
            </div>

            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm text-gray-400">轮播图</label>
                    <span class="text-xs text-gray-500">最多 8 张，可调整顺序</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3">
                    <input type="text" id="gallery-url-input" placeholder="图片URL..." class="flex-grow p-2 rounded bg-slate-800 border border-slate-600 text-white">
                    <button type="button" onclick="addGalleryUrl()" class="bg-slate-700 px-3 rounded hover:bg-slate-600 text-sm">添加URL</button>
                    <label class="bg-blue-600 px-4 py-2 rounded cursor-pointer hover:bg-blue-700 text-sm font-medium">
                        <i class="fas fa-images mr-1"></i> 上传
                        <input type="file" id="gallery-file-input" class="hidden" accept="image/*" multiple onchange="handleGalleryUpload(this)">
                    </label>
                </div>
                <div id="gallery-list" class="space-y-2"></div>
            </div>

            <div class="mb-6">
                <label class="block text-sm text-gray-400 mb-2">商品详情</label>
                <div class="border border-slate-700 rounded-lg overflow-hidden">
                    <div id="editor-container"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">支持加粗、列表、链接等基础格式。</p>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal('product-modal')" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600">取消</button>
                <button type="button" onclick="saveProduct()" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">保存商品</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <div id="reset-banner" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 glass-panel px-5 py-3 rounded-xl shadow-xl flex flex-wrap items-center gap-4 border border-red-500/40 z-40">
        <p class="text-sm text-red-200">检测到本地数据异常，可一键恢复到示例数据。</p>
        <div class="flex gap-2">
            <button type="button" onclick="resetDatabase()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">重置数据</button>
            <button type="button" onclick="dismissResetBanner()" class="bg-slate-700 hover:bg-slate-600 text-gray-200 px-3 py-1 rounded text-sm">稍后处理</button>
        </div>
    </div>

<script>
        const STORAGE_KEY = 'gpt_shop_db';
        const ADMIN_SESSION_KEY = 'gpt_shop_admin_authed';
        const DEFAULT_PASSWORD = 'admin2025';
        const MAX_GALLERY_COUNT = 8;
        const MAX_IMAGE_SIZE = 4 * 1024 * 1024;
        const FALLBACK_IMAGE = 'https://via.placeholder.com/800x500?text=AI+Product';

        let dbLoadFailed = false;
        let db = loadDb();
        let isAdmin = localStorage.getItem(ADMIN_SESSION_KEY) === 'true';
        let titleClickCount = 0;
        let titleClickTimer;
        let quill;
        let currentEditId = null;
        let tempCoverImage = '';
        let tempGallery = [];

        function init() {
            initParticles();
            initEditor();
            trackVisit();
            updateGlobalConfig();
            setupEventListeners();
            renderHome();

            if (isAdmin) {
                document.getElementById('admin-link').classList.remove('hidden');
            }

            if (dbLoadFailed) {
                showResetBanner();
            }
        }

        function initParticles() {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: '#ffffff' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.5, random: true },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: '#ffffff', opacity: 0.2, width: 1 },
                    move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } },
                    modes: { repulse: { distance: 100, duration: 0.4 } }
                },
                retina_detect: true
            });
        }

        function initEditor() {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ header: [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['link'],
                        ['clean']
                    ]
                }
            });
        }

        function trackVisit() {
            try {
                if (!sessionStorage.getItem('visit_tracked')) {
                    db.stats.visits++;
                    saveDb();
                    sessionStorage.setItem('visit_tracked', 'true');
                }
            } catch (error) {
                console.warn('Visit tracking failed', error);
            }
        }

        function updateGlobalConfig() {
            document.getElementById('site-title').innerText = db.config.title;
            document.title = db.config.title;
            document.getElementById('footer-contact').innerHTML = `联系我们: <i class="fab fa-weixin"></i> ${escapeHtml(db.config.wechat)} | <i class="fab fa-qq"></i> ${escapeHtml(db.config.qq)} | <i class="fas fa-envelope"></i> ${escapeHtml(db.config.email)}`;
            document.getElementById('modal-wechat').innerText = db.config.wechat;
            document.getElementById('modal-qq').innerText = db.config.qq;
        }

        function setupEventListeners() {
            const title = document.getElementById('site-title');
            title.addEventListener('click', () => {
                titleClickCount++;
                clearTimeout(titleClickTimer);
                titleClickTimer = setTimeout(() => { titleClickCount = 0; }, 2000);

                if (titleClickCount === 5) {
                    titleClickCount = 0;
                    if (isAdmin) {
                        renderAdmin();
                    } else {
                        openModal('login-modal');
                    }
                }
            });
        }

        function renderHome() {
            const app = document.getElementById('app');
            const products = loadProducts().filter(p => p.enabled);
            if (products.length === 0) {
                app.innerHTML = `
                <div class="glass-panel rounded-xl p-10 text-center space-y-4">
                    <h2 class="text-2xl font-semibold text-blue-400">暂未上架商品</h2>
                    <p class="text-gray-400">请稍后再来，或联系客服了解更多定制服务。</p>
                    ${isAdmin ? `<button onclick="renderAdmin(0)" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded">前往后台添加商品</button>` : ''}
                </div>`;
                window.scrollTo(0, 0);
                return;
            }

            let html = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">`;
            products.forEach(p => {
                const cover = p.coverImage || FALLBACK_IMAGE;
                const shortDesc = truncate(p.shortDesc || stripHtml(p.detailHtml), 80);
                const stockBadge = p.stock > 0
                    ? `<span class="bg-green-600 text-xs px-2 py-1 rounded text-white">库存: ${p.stock}</span>`
                    : `<span class="bg-red-600 text-xs px-2 py-1 rounded text-white">缺货</span>`;
                const tagHtml = p.tags && p.tags.length
                    ? `<div class="mt-3 flex flex-wrap gap-1">${p.tags.map(tag => `<span class="px-2 py-0.5 text-xs rounded-full bg-slate-800 border border-slate-700 text-gray-300">#${escapeHtml(tag)}</span>`).join('')}</div>`
                    : '';

                html += `
                <div class="product-card glass-panel rounded-xl overflow-hidden cursor-pointer flex flex-col" onclick="renderProductDetail('${p.id}')">
                    <div class="h-48 overflow-hidden bg-slate-800 flex items-center justify-center">
                        <img src="${cover}" class="w-full h-full object-cover hover:scale-110 transition duration-500" alt="${escapeHtml(p.name)}">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold mb-2 truncate">${escapeHtml(p.name)}</h3>
                        <p class="text-sm text-gray-400 flex-grow">${escapeHtml(shortDesc)}</p>
                        ${tagHtml}
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-xl font-bold text-blue-400">¥${escapeHtml(p.price)}</span>
                            ${stockBadge}
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            app.innerHTML = html;
            window.scrollTo(0, 0);
        }

        function renderProductDetail(id) {
            const products = loadProducts();
            const product = products.find(p => p.id === id);
            if (!product) {
                showToast('未找到该商品', 'error');
                return renderHome();
            }
            if (!product.enabled && !isAdmin) {
                showToast('该商品已下架', 'error');
                return renderHome();
            }

            if (!db.stats.views[id]) {
                db.stats.views[id] = 0;
            }
            db.stats.views[id]++;
            saveDb();

            const hero = product.coverImage || product.gallery[0] || FALLBACK_IMAGE;
            const gallery = product.gallery && product.gallery.length ? product.gallery : (product.coverImage ? [product.coverImage] : []);
            let galleryHtml = '';
            if (gallery.length > 1) {
                galleryHtml = `<div class="flex gap-2 overflow-x-auto pb-2">
                    ${gallery.map(img => `<img src="${img}" class="w-24 h-24 object-cover rounded border border-slate-700 cursor-pointer hover:opacity-80" data-src="${img}" onclick="updateDetailHeroImage(this.dataset.src)">`).join('')}
                </div>`;
            }

            const tagsHtml = product.tags && product.tags.length
                ? `<div class="flex flex-wrap gap-2 mt-3">${product.tags.map(tag => `<span class="px-2 py-0.5 text-xs rounded-full bg-slate-800 border border-slate-700 text-gray-300">#${escapeHtml(tag)}</span>`).join('')}</div>`
                : '';

            const app = document.getElementById('app');
            app.innerHTML = `
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-[65%]">
                    <button onclick="renderHome()" class="mb-4 text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i> 返回首页</button>
                    <div class="mb-6 rounded-xl overflow-hidden border border-slate-700 bg-slate-900">
                        <img id="detail-hero-img" src="${hero}" class="w-full h-auto max-h-[500px] object-contain bg-slate-900">
                    </div>
                    ${galleryHtml}
                    <div class="glass-panel p-6 rounded-xl mt-6">
                        <h2 class="text-2xl font-bold mb-2 border-b border-slate-700 pb-2">${escapeHtml(product.name)}</h2>
                        <p class="text-gray-300">${escapeHtml(product.shortDesc || '暂无简介')}</p>
                        ${tagsHtml}
                        <div class="prose prose-invert max-w-none text-gray-200 mt-6">
                            ${product.detailHtml || '<p>暂无介绍</p>'}
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-[35%] relative">
                    <div class="sticky top-24 glass-panel p-6 rounded-xl border-t-4 border-blue-500">
                        <div class="text-sm text-gray-400 mb-6">浏览量: ${db.stats.views[id] || 0}</div>
                        <div class="flex justify-between items-end mb-6">
                            <div class="text-3xl font-bold text-blue-400">¥${escapeHtml(product.price)}</div>
                            <div class="${product.stock > 0 ? 'text-green-400' : 'text-red-400'} font-bold">
                                ${product.stock > 0 ? `库存: ${product.stock}` : '暂时缺货'}
                            </div>
                        </div>
                        <button onclick="${product.stock > 0 ? "openModal('buy-modal')" : ''}"
                            class="w-full py-4 rounded-lg font-bold text-lg transition transform active:scale-95 ${product.stock > 0 ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}">
                            ${product.stock > 0 ? '立即购买' : '缺货中'}
                        </button>
                        <div class="mt-6 text-sm text-gray-400 space-y-2">
                            <p><i class="fas fa-check-circle text-green-500"></i> 24小时自动发货</p>
                            <p><i class="fas fa-check-circle text-green-500"></i> 售后无忧保障</p>
                            <p><i class="fas fa-shield-alt text-green-500"></i> 安全支付交易</p>
                        </div>
                    </div>
                </div>
            </div>`;
            window.scrollTo(0, 0);
        }

        function updateDetailHeroImage(url) {
            const hero = document.getElementById('detail-hero-img');
            if (hero && url) {
                hero.src = url;
            }
        }

        function renderAdmin(tabIndex = 0) {
            if (!isAdmin) return;

            const app = document.getElementById('app');
            const tabs = ['商品管理', '访问统计', '网站设置'];
            let tabContent = '';

            if (tabIndex === 0) {
                let products = loadProducts().sort((a, b) => b.updatedAt - a.updatedAt);
                let rows = products.map(p => `
                    <tr class="border-b border-slate-700 hover:bg-slate-800/60">
                        <td class="p-3">
                            <div class="font-semibold">${escapeHtml(p.name)}</div>
                            <div class="text-xs text-gray-500">${formatDateTime(p.updatedAt)}</div>
                        </td>
                        <td class="p-3">¥${escapeHtml(p.price)}</td>
                        <td class="p-3">${p.stock}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${p.enabled ? 'bg-green-600/30 text-green-300 border border-green-500/40' : 'bg-slate-700 text-gray-400 border border-slate-600'}">
                                ${p.enabled ? '启用中' : '已停用'}
                            </span>
                        </td>
                        <td class="p-3 text-right flex flex-wrap gap-2 justify-end">
                            <button class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs" onclick="toggleProductEnabled('${p.id}')">
                                ${p.enabled ? '下架' : '上架'}
                            </button>
                            <button class="text-blue-400 hover:text-blue-300" onclick="openEditProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                if (!rows) {
                    rows = `<tr><td colspan="5" class="text-center py-6 text-gray-400">暂无商品，请点击“新增商品”开始添加。</td></tr>`;
                }

                tabContent = `
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                        <h3 class="text-xl font-bold">商品列表</h3>
                        <button onclick="openEditProduct(null)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"><i class="fas fa-plus"></i> 新增商品</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-gray-400 border-b border-slate-600">
                                    <th class="p-3">名称</th>
                                    <th class="p-3">价格</th>
                                    <th class="p-3">库存</th>
                                    <th class="p-3">状态</th>
                                    <th class="p-3 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            } else if (tabIndex === 1) {
                const products = loadProducts();
                const totalViews = Object.values(db.stats.views || {}).reduce((a, b) => a + b, 0);
                const productStats = products
                    .map(p => ({ name: p.name, views: db.stats.views[p.id] || 0 }))
                    .sort((a, b) => b.views - a.views)
                    .map(item => `<div class="flex justify-between p-2 border-b border-slate-700"><span>${escapeHtml(item.name)}</span><span class="font-mono">${item.views}</span></div>`)
                    .join('');

                tabContent = `
                    <h3 class="text-xl font-bold mb-6">数据统计</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="glass-panel p-6 rounded-xl text-center">
                            <div class="text-4xl font-bold text-blue-400 mb-2">${db.stats.visits}</div>
                            <div class="text-gray-400">总访问人次 (Session)</div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl text-center">
                            <div class="text-4xl font-bold text-green-400 mb-2">${totalViews}</div>
                            <div class="text-gray-400">商品总浏览量</div>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl">
                        <h4 class="font-bold mb-4">商品热度排行</h4>
                        <div class="max-h-60 overflow-y-auto">${productStats || '<p class="text-sm text-gray-500">暂无数据</p>'}</div>
                    </div>
                `;
            } else {
                tabContent = `
                    <h3 class="text-xl font-bold mb-6">网站设置</h3>
                    <form onsubmit="saveSiteSettings(event)" class="max-w-xl space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">网站标题</label>
                            <input type="text" name="title" value="${escapeHtml(db.config.title)}" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">微信号</label>
                                <input type="text" name="wechat" value="${escapeHtml(db.config.wechat)}" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">QQ号</label>
                                <input type="text" name="qq" value="${escapeHtml(db.config.qq)}" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">联系邮箱</label>
                            <input type="email" name="email" value="${escapeHtml(db.config.email)}" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white">
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">保存设置</button>
                    </form>
                    <div class="mt-10 max-w-xl">
                        <h4 class="font-semibold mb-3">修改管理员密码</h4>
                        <form onsubmit="changePassword(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">当前密码</label>
                                <input type="password" name="currentPassword" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">新密码</label>
                                <input type="password" name="newPassword" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">确认新密码</label>
                                <input type="password" name="confirmPassword" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" required>
                            </div>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">更新密码</button>
                        </form>
                        <div class="glass-panel rounded-xl p-4 mt-8 border border-red-500/40">
                            <div class="flex items-center justify-between gap-4 flex-wrap">
                                <div>
                                    <h5 class="font-semibold text-red-300">重置本地数据</h5>
                                    <p class="text-sm text-gray-400 mt-1">清空所有自定义内容并恢复示例数据。</p>
                                </div>
                                <button type="button" onclick="resetDatabase()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">重置示例数据</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            app.innerHTML = `
                <div class="glass-panel rounded-xl min-h-[600px] flex flex-col md:flex-row overflow-hidden">
                    <div class="w-full md:w-52 bg-slate-800/50 border-r border-slate-700 flex flex-col">
                        <div class="p-4 font-bold text-center border-b border-slate-700">后台管理</div>
                        ${tabs.map((t, i) => `
                            <button onclick="renderAdmin(${i})" class="p-4 text-left hover:bg-slate-700 ${i === tabIndex ? 'bg-slate-700 text-blue-400 border-l-4 border-blue-400' : 'text-gray-400'}">
                                ${t}
                            </button>
                        `).join('')}
                        <button onclick="logout()" class="mt-auto p-4 text-left text-red-400 hover:bg-slate-700 border-t border-slate-700">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </button>
                    </div>
                    <div class="flex-grow p-6 overflow-y-auto">
                        ${tabContent}
                    </div>
                </div>
            `;
            window.scrollTo(0, 0);
        }

        function openEditProduct(id) {
            currentEditId = id;
            const products = loadProducts();
            const product = id ? products.find(p => p.id === id) : null;

            document.getElementById('product-modal-title').innerText = id ? '编辑商品' : '新增商品';
            document.getElementById('edit-name').value = product ? product.name : '';
            document.getElementById('edit-price').value = product ? product.price : '';
            document.getElementById('edit-stock').value = product ? product.stock : 0;
            document.getElementById('edit-tags').value = product ? product.tags.join(', ') : '';
            document.getElementById('edit-short-desc').value = product ? (product.shortDesc || '') : '';
            document.getElementById('edit-enabled').checked = product ? product.enabled : true;
            document.getElementById('cover-url-input').value = '';
            document.getElementById('gallery-url-input').value = '';

            tempCoverImage = product ? (product.coverImage || '') : '';
            tempGallery = product ? [...(product.gallery || [])] : [];

            quill.root.innerHTML = product ? (product.detailHtml || '') : '';

            renderCoverPreview();
            renderGalleryList();
            openModal('product-modal');
        }

        function renderCoverPreview() {
            const preview = document.getElementById('cover-preview');
            if (!preview) return;
            if (tempCoverImage) {
                preview.innerHTML = `<img src="${tempCoverImage}" class="w-full h-full object-cover rounded-xl border border-slate-700">`;
            } else {
                preview.innerHTML = `<span class="text-sm text-gray-500">暂无主图</span>`;
            }
        }

        function renderGalleryList() {
            const list = document.getElementById('gallery-list');
            if (!list) return;
            if (!tempGallery.length) {
                list.innerHTML = `<p class="text-sm text-gray-500">暂无轮播图，可通过 URL 或本地上传添加。</p>`;
                return;
            }

            list.innerHTML = tempGallery.map((img, idx) => `
                <div class="flex items-center gap-3 glass-panel bg-slate-900/70 border border-slate-700 p-2 rounded-xl">
                    <img src="${img}" class="w-16 h-16 object-cover rounded border border-slate-600">
                    <span class="text-xs text-gray-500">第 ${idx + 1} 张</span>
                    <div class="flex gap-1 ml-auto">
                        <button type="button" onclick="moveGalleryImage(${idx}, -1)" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs ${idx === 0 ? 'opacity-40 pointer-events-none' : ''}">上移</button>
                        <button type="button" onclick="moveGalleryImage(${idx}, 1)" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs ${idx === tempGallery.length - 1 ? 'opacity-40 pointer-events-none' : ''}">下移</button>
                        <button type="button" onclick="removeGalleryImage(${idx})" class="px-2 py-1 rounded bg-red-600 hover:bg-red-700 text-xs text-white">删除</button>
                    </div>
                </div>
            `).join('');
        }

        function applyCoverUrl() {
            const input = document.getElementById('cover-url-input');
            const url = input.value.trim();
            if (!url) {
                showToast('请输入主图地址', 'error');
                return;
            }
            tempCoverImage = url;
            input.value = '';
            renderCoverPreview();
            showToast('主图已更新');
        }

        function addGalleryUrl() {
            const input = document.getElementById('gallery-url-input');
            const url = input.value.trim();
            if (!url) {
                showToast('请输入图片地址', 'error');
                return;
            }
            if (tempGallery.length >= MAX_GALLERY_COUNT) {
                showToast(`最多可添加 ${MAX_GALLERY_COUNT} 张图片`, 'error');
                return;
            }
            tempGallery.push(url);
            input.value = '';
            renderGalleryList();
            showToast('已添加轮播图');
        }

        function handleCoverUpload(input) {
            const file = input.files && input.files[0];
            if (!file) return;
            if (file.size > MAX_IMAGE_SIZE) {
                showToast('图片大小不能超过4MB', 'error');
                input.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                tempCoverImage = e.target.result;
                renderCoverPreview();
                showToast('主图上传成功');
            };
            reader.onerror = () => showToast('图片读取失败', 'error');
            reader.readAsDataURL(file);
            input.value = '';
        }

        function handleGalleryUpload(input) {
            const files = Array.from(input.files || []);
            if (!files.length) return;
            for (const file of files) {
                if (tempGallery.length >= MAX_GALLERY_COUNT) {
                    showToast(`最多可添加 ${MAX_GALLERY_COUNT} 张图片`, 'error');
                    break;
                }
                if (file.size > MAX_IMAGE_SIZE) {
                    showToast(`${file.name} 超过 4MB，已跳过`, 'error');
                    continue;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    tempGallery.push(e.target.result);
                    renderGalleryList();
                };
                reader.onerror = () => showToast(`图片 ${file.name} 读取失败`, 'error');
                reader.readAsDataURL(file);
            }
            input.value = '';
        }

        function removeGalleryImage(index) {
            tempGallery.splice(index, 1);
            renderGalleryList();
        }

        function moveGalleryImage(index, delta) {
            const target = index + delta;
            if (target < 0 || target >= tempGallery.length) return;
            const value = tempGallery[index];
            tempGallery[index] = tempGallery[target];
            tempGallery[target] = value;
            renderGalleryList();
        }

        function saveProduct() {
            const name = document.getElementById('edit-name').value.trim();
            const price = document.getElementById('edit-price').value.trim();
            const stockValue = parseInt(document.getElementById('edit-stock').value, 10);
            const shortDesc = document.getElementById('edit-short-desc').value.trim();
            const tags = parseTags(document.getElementById('edit-tags').value);
            const enabled = document.getElementById('edit-enabled').checked;
            const detailHtml = quill.root.innerHTML;

            if (!name || !price) {
                showToast('请填写完整的商品名称和价格', 'error');
                return;
            }

            const gallery = tempGallery.filter(Boolean).slice(0, MAX_GALLERY_COUNT);
            const coverImage = tempCoverImage || gallery[0] || FALLBACK_IMAGE;
            const now = Date.now();
            let products = loadProducts();

            if (currentEditId) {
                const idx = products.findIndex(p => p.id === currentEditId);
                if (idx === -1) {
                    showToast('商品不存在', 'error');
                    return;
                }
                const original = products[idx];
                products[idx] = {
                    ...original,
                    name,
                    price,
                    stock: isNaN(stockValue) ? 0 : stockValue,
                    shortDesc,
                    tags,
                    coverImage,
                    gallery,
                    detailHtml,
                    enabled,
                    updatedAt: now
                };
            } else {
                const newProduct = {
                    id: generateId(),
                    name,
                    price,
                    stock: isNaN(stockValue) ? 0 : stockValue,
                    shortDesc,
                    tags,
                    coverImage,
                    gallery,
                    detailHtml,
                    enabled,
                    createdAt: now,
                    updatedAt: now
                };
                products.push(newProduct);
                db.stats.views[newProduct.id] = 0;
            }

            saveProducts(products);
            closeModal('product-modal');
            renderAdmin(0);
            renderHome();
            showToast('商品已保存');
        }

        function deleteProduct(id) {
            if (!confirm('确定删除该商品吗？删除后无法恢复。')) return;
            const products = loadProducts();
            const filtered = products.filter(p => p.id !== id);
            if (filtered.length === products.length) {
                showToast('未找到该商品', 'error');
                return;
            }
            delete db.stats.views[id];
            saveProducts(filtered);
            renderAdmin(0);
            renderHome();
            showToast('商品已删除', 'info');
        }

        function toggleProductEnabled(id) {
            const products = loadProducts();
            const idx = products.findIndex(p => p.id === id);
            if (idx === -1) return;
            products[idx].enabled = !products[idx].enabled;
            products[idx].updatedAt = Date.now();
            saveProducts(products);
            renderAdmin(0);
            renderHome();
            showToast(products[idx].enabled ? '商品已上架' : '商品已下架', 'info');
        }

        function saveSiteSettings(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            db.config.title = formData.get('title').trim() || 'GPT Store';
            db.config.wechat = formData.get('wechat').trim();
            db.config.qq = formData.get('qq').trim();
            db.config.email = formData.get('email').trim();
            saveDb();
            updateGlobalConfig();
            showToast('网站信息已更新');
        }

        function changePassword(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const currentPassword = formData.get('currentPassword').trim();
            const newPassword = formData.get('newPassword').trim();
            const confirmPassword = formData.get('confirmPassword').trim();

            if (!verifyPassword(currentPassword)) {
                showToast('当前密码不正确', 'error');
                return;
            }
            if (newPassword.length < 6) {
                showToast('新密码至少 6 位字符', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast('两次输入的新密码不一致', 'error');
                return;
            }

            const salt = generateSalt();
            db.config.adminSalt = salt;
            db.config.adminHash = hashPassword(newPassword, salt);
            saveDb();
            event.target.reset();
            showToast('管理员密码已更新');
        }

        function resetDatabase() {
            if (!confirm('确定要清空所有商品并恢复示例数据吗？该操作不可撤销。')) {
                return;
            }
            db = getDefaultDb();
            saveDb();
            isAdmin = false;
            localStorage.removeItem(ADMIN_SESSION_KEY);
            document.getElementById('admin-link').classList.add('hidden');
            updateGlobalConfig();
            renderHome();
            closeModal('product-modal');
            dismissResetBanner();
            showToast('已恢复默认示例数据', 'info');
        }

        function attemptLogin() {
            const input = document.getElementById('admin-pass-input');
            const password = input.value.trim();
            if (!password) {
                showToast('请输入密码', 'error');
                return;
            }
            if (verifyPassword(password)) {
                isAdmin = true;
                localStorage.setItem(ADMIN_SESSION_KEY, 'true');
                closeModal('login-modal');
                input.value = '';
                document.getElementById('admin-link').classList.remove('hidden');
                renderAdmin();
                showToast('登录成功');
            } else {
                showToast('密码错误', 'error');
            }
        }

        function logout() {
            isAdmin = false;
            localStorage.removeItem(ADMIN_SESSION_KEY);
            document.getElementById('admin-link').classList.add('hidden');
            renderHome();
            showToast('已退出登录', 'info');
        }

        function loadDb() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                const fresh = getDefaultDb();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fresh));
                return fresh;
            }
            try {
                return normalizeDb(JSON.parse(raw));
            } catch (error) {
                console.warn('DB parse failed, fallback to default', error);
                dbLoadFailed = true;
                const fallback = getDefaultDb();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fallback));
                return fallback;
            }
        }

        function saveDb() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            } catch (error) {
                console.error('Failed to persist DB', error);
                showToast('保存失败，请检查浏览器存储权限', 'error');
            }
        }

        function getDefaultDb() {
            const sample = createSampleProduct();
            const salt = generateSalt();
            return {
                config: {
                    title: 'GPT 极速发货',
                    wechat: 'GPT_Shop_Admin',
                    qq: '88888888',
                    email: 'admin@gptstore.com',
                    adminSalt: salt,
                    adminHash: hashPassword(DEFAULT_PASSWORD, salt)
                },
                products: [sample],
                stats: {
                    visits: 0,
                    views: { [sample.id]: 0 }
                }
            };
        }

        function createSampleProduct() {
            const now = Date.now();
            const gallery = [
                'https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg',
                'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/OpenAI_Logo.svg/512px-OpenAI_Logo.svg.png'
            ];
            return {
                id: generateId(),
                name: 'ChatGPT Plus 独享号',
                shortDesc: '官方 Plus 账号，极速发货，支持 GPT-4 与最新模型。',
                price: '198',
                tags: ['GPT-4', 'Plus', '独享'],
                coverImage: gallery[0],
                gallery,
                detailHtml: '<p><strong>官方正版订阅</strong></p><p>支持 GPT-4、DALL·E 3、联网与高级数据分析。</p><ul><li>独享账号，可改密</li><li>质保 30 天</li><li>下单后 10 分钟内交付</li></ul>',
                createdAt: now,
                updatedAt: now,
                enabled: true,
                stock: 10
            };
        }

        function normalizeDb(data) {
            const normalized = { ...data };
            normalized.config = normalized.config || {};
            if (!normalized.config.adminSalt || !normalized.config.adminHash) {
                const salt = generateSalt();
                const sourcePassword = normalized.config.password || DEFAULT_PASSWORD;
                normalized.config.adminSalt = salt;
                normalized.config.adminHash = hashPassword(sourcePassword, salt);
                delete normalized.config.password;
            }
            normalized.config.title = normalized.config.title || 'GPT Store';
            normalized.config.wechat = normalized.config.wechat || '';
            normalized.config.qq = normalized.config.qq || '';
            normalized.config.email = normalized.config.email || '';

            normalized.products = Array.isArray(normalized.products) ? normalized.products.map(normalizeProduct) : [];
            normalized.stats = normalized.stats || { visits: 0, views: {} };
            normalized.stats.visits = normalized.stats.visits || 0;
            normalized.stats.views = normalized.stats.views || {};
            normalized.products.forEach(p => {
                if (typeof normalized.stats.views[p.id] !== 'number') {
                    normalized.stats.views[p.id] = 0;
                }
            });
            return normalized;
        }

        function normalizeProduct(product) {
            const now = Date.now();
            const gallery = Array.isArray(product.gallery)
                ? product.gallery.filter(Boolean)
                : Array.isArray(product.images) ? product.images.filter(Boolean) : [];
            const coverImage = product.coverImage || gallery[0] || FALLBACK_IMAGE;
            const tags = Array.isArray(product.tags) ? product.tags : parseTags(product.tags || '');

            return {
                id: String(product.id || generateId()),
                name: product.name || '未命名商品',
                shortDesc: product.shortDesc || stripHtml(product.desc || ''),
                price: product.price !== undefined ? String(product.price) : '0',
                tags,
                coverImage,
                gallery,
                detailHtml: product.detailHtml || product.desc || '',
                createdAt: product.createdAt || now,
                updatedAt: product.updatedAt || now,
                enabled: typeof product.enabled === 'boolean' ? product.enabled : true,
                stock: typeof product.stock === 'number' ? product.stock : (typeof product.inventory === 'number' ? product.inventory : 0)
            };
        }

        function loadProducts() {
            return Array.isArray(db.products) ? [...db.products] : [];
        }

        function saveProducts(products) {
            db.products = products.map(normalizeProduct);
            ensureProductViews();
            saveDb();
        }

        function ensureProductViews() {
            db.stats = db.stats || { visits: 0, views: {} };
            db.stats.views = db.stats.views || {};
            db.products.forEach(p => {
                if (typeof db.stats.views[p.id] !== 'number') {
                    db.stats.views[p.id] = 0;
                }
            });
        }

        function generateSalt(length = 16) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash << 5) - hash + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash).toString(16);
        }

        function hashPassword(password, salt) {
            return simpleHash(`${salt}::${password}`);
        }

        function verifyPassword(password) {
            if (!password) return false;
            return hashPassword(password, db.config.adminSalt) === db.config.adminHash;
        }

        function generateId() {
            if (window.crypto && window.crypto.randomUUID) {
                return window.crypto.randomUUID();
            }
            return 'prod-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        }

        function stripHtml(html = '') {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function truncate(str = '', max = 80) {
            const plain = String(str);
            return plain.length > max ? `${plain.slice(0, max)}…` : plain;
        }

        function parseTags(value) {
            if (!value) return [];
            if (Array.isArray(value)) return value.filter(Boolean);
            return value.split(',').map(tag => tag.trim()).filter(Boolean);
        }

        function escapeHtml(str = '') {
            return String(str).replace(/[&<>"']/g, s => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[s]);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '--';
            const date = new Date(timestamp);
            const pad = (num) => String(num).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.remove('active');
            if (id === 'product-modal') {
                currentEditId = null;
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) {
                alert(message);
                return;
            }
            const colors = {
                success: 'border-green-500/70 text-green-100',
                error: 'border-red-500/70 text-red-100',
                info: 'border-blue-500/70 text-blue-100'
            };
            const toast = document.createElement('div');
            toast.className = `glass-panel border-l-4 px-4 py-3 text-sm shadow-xl ${colors[type] || colors.success}`;
            toast.textContent = message;
            toast.style.pointerEvents = 'auto';
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2800);
            setTimeout(() => {
                toast.remove();
            }, 3300);
        }

        function showResetBanner() {
            const banner = document.getElementById('reset-banner');
            if (banner) {
                banner.classList.remove('hidden');
            }
        }

        function dismissResetBanner() {
            const banner = document.getElementById('reset-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
            dbLoadFailed = false;
        }

        window.onload = init;
    </script>
</body>
</html>